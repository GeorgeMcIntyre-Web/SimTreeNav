name: CI Smoke Test

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  smoke-test:
    name: Run Smoke Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify PowerShell version
        run: |
          pwsh -Version
          pwsh -Command '$PSVersionTable.PSVersion'

      - name: Create output directories
        run: |
          mkdir -p out/logs out/json test/integration/results test/unit/results
          echo "Created required directories for test outputs"

      - name: Run unit tests (RunStatus library)
        run: |
          pwsh -File test/integration/Test-RunStatus.ps1
        continue-on-error: false

      - name: Run library coverage tests
        run: |
          pwsh -File test/unit/Invoke-CoverageTests.ps1 -CI
        continue-on-error: false

      - name: Run integration smoke test
        run: |
          pwsh -File test/integration/Test-ReleaseSmoke.ps1 -OutDir ./out -SkipFullRun
        continue-on-error: false

      - name: Display run-status.json
        if: always()
        run: |
          if [ -f ./out/json/run-status.json ]; then
            echo "=== run-status.json ==="
            cat ./out/json/run-status.json
          else
            echo "run-status.json not found"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test/integration/results/*.json
            test/unit/results/*.json
            test/unit/results/*.xml
            out/logs/*.log
            out/json/run-status.json
          retention-days: 30
          if-no-files-found: warn

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            out/
          retention-days: 7
          if-no-files-found: warn

  secrets-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for hardcoded secrets
        run: |
          # Make scanner executable
          chmod +x scripts/security/scan-secrets.sh

          # Run the enhanced secret scanner
          bash scripts/security/scan-secrets.sh

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [smoke-test, secrets-scan]
    if: always()

    steps:
      - name: Check test results
        run: |
          SMOKE_RESULT="${{ needs.smoke-test.result }}"
          SECRETS_RESULT="${{ needs.secrets-scan.result }}"

          echo "=== Test Summary ==="
          echo "Smoke Tests: $SMOKE_RESULT"
          echo "Secrets Scan: $SECRETS_RESULT"
          echo ""

          if [ "$SMOKE_RESULT" = "success" ] && [ "$SECRETS_RESULT" = "success" ]; then
            echo "✓ All checks passed"
            exit 0
          else
            echo "✗ Some checks failed"
            exit 1
          fi
