-- Minimal Siemens-compatible schema for local dev (no dump required)
-- Run as SYS AS SYSDBA. Creates DESIGN1 user and tables used by SimTreeNav tree.
-- After running, use schema DESIGN1 and project ID 100 in the tree launcher.

WHENEVER SQLERROR EXIT FAILURE
SET ECHO ON

-- Create schema (user) DESIGN1
BEGIN
  EXECUTE IMMEDIATE 'DROP USER DESIGN1 CASCADE';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -1918 THEN RAISE; END IF;  -- user does not exist
END;
/

CREATE USER DESIGN1 IDENTIFIED BY DESIGN1
  DEFAULT TABLESPACE PP_DATA_128K
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON PP_DATA_128K
  QUOTA UNLIMITED ON PP_INDEX_128K;

GRANT CONNECT, RESOURCE TO DESIGN1;
GRANT CREATE VIEW TO DESIGN1;

-- COLLECTION_: tree nodes (projects, folders, studies, etc.)
CREATE TABLE DESIGN1.COLLECTION_ (
  OBJECT_ID        NUMBER NOT NULL,
  CAPTION_S_       NVARCHAR2(512),
  NAME_            NVARCHAR2(512),
  NAME1_S_         NVARCHAR2(512),
  EXTERNALID_S_    VARCHAR2(1024),
  CLASS_ID         NUMBER,
  MODIFICATIONDATE_DA_ DATE,
  CONSTRAINT COLLECTION_PK PRIMARY KEY (OBJECT_ID)
);

-- REL_COMMON: parent-child edges and display order
CREATE TABLE DESIGN1.REL_COMMON (
  REL_COMMON_ID    NUMBER NOT NULL,
  OBJECT_ID        NUMBER NOT NULL,
  FORWARD_OBJECT_ID NUMBER NOT NULL,
  PROJECT_ID       NUMBER NOT NULL,
  SEQ_NUMBER       NUMBER,
  CONSTRAINT REL_COMMON_PK PRIMARY KEY (REL_COMMON_ID)
);
CREATE INDEX DESIGN1.REL_FWD_IDX ON DESIGN1.REL_COMMON(FORWARD_OBJECT_ID, PROJECT_ID);
CREATE INDEX DESIGN1.REL_OBJ_IDX ON DESIGN1.REL_COMMON(OBJECT_ID, PROJECT_ID);

-- CLASS_DEFINITIONS: type names and icon inheritance
CREATE TABLE DESIGN1.CLASS_DEFINITIONS (
  TYPE_ID      NUMBER NOT NULL,
  NAME        VARCHAR2(512),
  NICE_NAME   VARCHAR2(512),
  DERIVED_FROM NUMBER,
  CONSTRAINT CLASS_DEF_PK PRIMARY KEY (TYPE_ID)
);

-- DF_ICONS_DATA: icon BLOBs (empty for seed; app uses fallback icons)
CREATE TABLE DESIGN1.DF_ICONS_DATA (
  TYPE_ID      NUMBER NOT NULL,
  CLASS_IMAGE  BLOB,
  CONSTRAINT DF_ICONS_PK PRIMARY KEY (TYPE_ID)
);

-- PART_: part/layout nodes (optional; tree uses LEFT JOIN so empty is OK)
CREATE TABLE DESIGN1.PART_ (
  OBJECT_ID    NUMBER NOT NULL,
  NAME_S_      NVARCHAR2(512),
  EXTERNALID_S_ VARCHAR2(1024),
  CLASS_ID     NUMBER,
  CONSTRAINT PART_PK PRIMARY KEY (OBJECT_ID)
);

-- USER_: for checkout display (optional)
CREATE TABLE DESIGN1.USER_ (
  OBJECT_ID    NUMBER NOT NULL,
  CAPTION_S_   NVARCHAR2(255),
  NAME_        NVARCHAR2(255),
  CONSTRAINT USER_PK PRIMARY KEY (OBJECT_ID)
);

-- PROXY: checkout status (optional)
CREATE TABLE DESIGN1.PROXY (
  OBJECT_ID           NUMBER,
  OWNER_ID            NUMBER,
  PROJECT_ID          NUMBER,
  WORKING_VERSION_ID  NUMBER
);

-- DFPROJECT: used by tree launcher to list projects (PROJECTID = COLLECTION_.OBJECT_ID of root)
CREATE TABLE DESIGN1.DFPROJECT (
  PROJECTID  NUMBER NOT NULL,
  CONSTRAINT DFPROJECT_PK PRIMARY KEY (PROJECTID)
);

-- Grant read to EMP_ADMIN so app can use DESIGN1 when connected as EMP_ADMIN or SYS
GRANT SELECT ON DESIGN1.COLLECTION_ TO EMP_ADMIN;
GRANT SELECT ON DESIGN1.REL_COMMON TO EMP_ADMIN;
GRANT SELECT ON DESIGN1.CLASS_DEFINITIONS TO EMP_ADMIN;
GRANT SELECT ON DESIGN1.DF_ICONS_DATA TO EMP_ADMIN;
GRANT SELECT ON DESIGN1.PART_ TO EMP_ADMIN;
GRANT SELECT ON DESIGN1.USER_ TO EMP_ADMIN;
GRANT SELECT ON DESIGN1.PROXY TO EMP_ADMIN;
GRANT SELECT ON DESIGN1.DFPROJECT TO EMP_ADMIN;

PROMPT Seed schema DESIGN1 created. Run 02-seed-data.sql next.

EXIT;
